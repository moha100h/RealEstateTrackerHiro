# راهنمای نصب آسان سیستم هوشمند مدیریت املاک هیرو

این راهنما به شما کمک می‌کند تا سیستم هوشمند مدیریت املاک هیرو را به سادگی روی سرور شخصی خود نصب کنید.

## ۱. پیش‌نیازها

برای نصب این سیستم، سرور شما باید دارای موارد زیر باشد:
- سیستم عامل لینوکس (ترجیحاً Ubuntu 20.04 یا بالاتر)
- Python 3.11 یا بالاتر
- PostgreSQL 13 یا بالاتر
- Nginx (اختیاری، برای محیط تولید)

## ۲. اطلاعات مورد نیاز

لطفاً اطلاعات زیر را آماده کنید:

### اطلاعات دیتابیس:
```
نام دیتابیس: [مثال: hiroestate]
کاربر دیتابیس: [مثال: hiroestate_user]
رمز عبور دیتابیس: [رمز عبور قوی]
میزبان دیتابیس: [مثال: localhost]
پورت دیتابیس: [مثال: 5432]
```

### اطلاعات مدیر سیستم:
```
نام کاربری مدیر سیستم: [مثال: admin]
رمز عبور مدیر سیستم: [رمز عبور قوی]
ایمیل مدیر سیستم: [ایمیل معتبر]
```

### اطلاعات سرور:
```
دامنه یا آی‌پی سرور: [مثال: example.com یا 123.45.67.89]
مسیر نصب: [مثال: /var/www/hiroestate]
```

## ۳. مراحل نصب (دستی)

### ۳.۱. ایجاد دیتابیس PostgreSQL

به عنوان کاربر postgres وارد شده و دستورات زیر را اجرا کنید:

```bash
sudo -u postgres psql
CREATE DATABASE hiroestate;
CREATE USER hiroestate_user WITH PASSWORD 'رمز_عبور_قوی';
ALTER ROLE hiroestate_user SET client_encoding TO 'utf8';
ALTER ROLE hiroestate_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE hiroestate_user SET timezone TO 'UTC';
GRANT ALL PRIVILEGES ON DATABASE hiroestate TO hiroestate_user;
\q
```

### ۳.۲. دانلود و نصب نرم‌افزار

```bash
# ایجاد پوشه پروژه
sudo mkdir -p /var/www/hiroestate
sudo chown $USER:$USER /var/www/hiroestate

# کلون کردن پروژه از گیت‌هاب (اگر موجود است)
# git clone https://github.com/your-username/hiroestate.git /var/www/hiroestate

# یا کپی کردن فایل‌ها به مسیر نصب
# نکته: این قسمت را با کپی کردن فایل‌های پروژه انجام دهید

# ایجاد محیط مجازی و نصب وابستگی‌ها
cd /var/www/hiroestate
python3 -m venv venv
source venv/bin/activate
pip install Django==5.2 dj-database-url==2.3.0 psycopg2-binary==2.9.9 Pillow==11.2.1 python-magic==0.4.27 django-filter==25.1 jdatetime==4.1.1 django-jalali==6.0.1 xlsxwriter==3.2.0 openpyxl==3.1.6 pandas==2.2.1 gunicorn==22.0.0 python-dotenv==1.0.1 whitenoise==6.6.0
```

### ۳.۳. تنظیم فایل محیطی (.env)

فایل `.env` را در مسیر اصلی پروژه با محتوای زیر ایجاد کنید:

```
DEBUG=False
SECRET_KEY=کلید_امنیتی_طولانی_و_پیچیده
DATABASE_URL=postgres://hiroestate_user:رمز_عبور_قوی@localhost:5432/hiroestate
ALLOWED_HOSTS=example.com,www.example.com,123.45.67.89
```

### ۳.۴. اجرای مهاجرت‌ها و ایجاد مدیر سیستم

```bash
# هنوز در محیط مجازی فعال
python manage.py migrate
python manage.py collectstatic --noinput
python manage.py createsuperuser
# اطلاعات مدیر سیستم را وارد کنید
```

### ۳.۵. تنظیم Gunicorn (برای محیط تولید)

یک فایل سرویس سیستمی برای Gunicorn ایجاد کنید:

```bash
sudo nano /etc/systemd/system/hiroestate.service
```

محتوای زیر را در فایل قرار دهید:

```
[Unit]
Description=Hiro Estate Gunicorn Service
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/hiroestate
ExecStart=/var/www/hiroestate/venv/bin/gunicorn --workers 3 --bind unix:/var/www/hiroestate/hiroestate.sock hiro_estate.wsgi:application
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

سرویس را فعال کنید:

```bash
sudo systemctl start hiroestate
sudo systemctl enable hiroestate
```

### ۳.۶. تنظیم Nginx (برای محیط تولید)

فایل کانفیگ Nginx را ایجاد کنید:

```bash
sudo nano /etc/nginx/sites-available/hiroestate
```

محتوای زیر را در فایل قرار دهید:

```
server {
    listen 80;
    server_name example.com www.example.com;  # دامنه یا آی‌پی خود را قرار دهید

    location = /favicon.ico { access_log off; log_not_found off; }
    
    location /static/ {
        root /var/www/hiroestate;
    }
    
    location /media/ {
        root /var/www/hiroestate;
    }
    
    location / {
        include proxy_params;
        proxy_pass http://unix:/var/www/hiroestate/hiroestate.sock;
    }
}
```

فایل کانفیگ را فعال کنید:

```bash
sudo ln -s /etc/nginx/sites-available/hiroestate /etc/nginx/sites-enabled
sudo nginx -t  # تست کانفیگ
sudo systemctl restart nginx
```

## ۴. نصب با Docker (راه ساده‌تر)

اگر Docker روی سرور شما نصب است، می‌توانید از Docker Compose برای نصب سریع استفاده کنید.

### ۴.۱. ایجاد فایل محیطی برای Docker

فایل `.env` را در مسیر اصلی پروژه با محتوای زیر ایجاد کنید:

```
POSTGRES_DB=hiroestate
POSTGRES_USER=hiroestate_user
POSTGRES_PASSWORD=رمز_عبور_قوی
DATABASE_URL=postgres://hiroestate_user:رمز_عبور_قوی@db:5432/hiroestate
DEBUG=False
SECRET_KEY=کلید_امنیتی_طولانی_و_پیچیده
ALLOWED_HOSTS=example.com,www.example.com,localhost,127.0.0.1
```

### ۴.۲. کپی و اجرای docker-compose

فایل docker-compose.yml را به سرور خود کپی کرده و اجرا کنید:

```bash
# کپی فایل‌های پروژه به سرور
# ساختار دایرکتوری به شکل زیر باشد:
# /path/to/project/
# ├── docker-compose.yml
# ├── Dockerfile
# ├── .env
# ├── nginx/
# │   └── conf/
# │       └── hiroestate.conf
# └── [سایر فایل‌های پروژه]

cd /path/to/project/
docker-compose up -d
```

### ۴.۳. ایجاد مدیر سیستم

```bash
docker-compose exec web python manage.py createsuperuser
# اطلاعات مدیر سیستم را وارد کنید
```

## ۵. تست نهایی و دسترسی

پس از نصب، می‌توانید از طریق مرورگر به سیستم دسترسی پیدا کنید:

- آدرس مدیریت: `http://دامنه-یا-آی‌پی-شما/admin/`
- آدرس صفحه اصلی: `http://دامنه-یا-آی‌پی-شما/`

## ۶. پشتیبان‌گیری منظم

برای پشتیبان‌گیری منظم از دیتابیس، می‌توانید یک کرون‌جاب تنظیم کنید:

```bash
# ایجاد اسکریپت پشتیبان‌گیری
sudo nano /var/www/hiroestate/backup.sh
```

محتوای اسکریپت:

```bash
#!/bin/bash
DATE=$(date +%Y-%m-%d_%H-%M-%S)
BACKUP_DIR="/path/to/backups"
mkdir -p $BACKUP_DIR

# پشتیبان‌گیری از دیتابیس
PGPASSWORD="رمز_عبور_قوی" pg_dump -h localhost -U hiroestate_user -d hiroestate -F c -f $BACKUP_DIR/hiroestate_db_$DATE.backup

# پشتیبان‌گیری از فایل‌های رسانه
tar -czf $BACKUP_DIR/hiroestate_media_$DATE.tar.gz /var/www/hiroestate/media

# حذف پشتیبان‌های قدیمی (بیشتر از 30 روز)
find $BACKUP_DIR -name "hiroestate_db_*.backup" -mtime +30 -delete
find $BACKUP_DIR -name "hiroestate_media_*.tar.gz" -mtime +30 -delete
```

اجرایی کردن اسکریپت و تنظیم کرون‌جاب:

```bash
sudo chmod +x /var/www/hiroestate/backup.sh
sudo crontab -e
```

اضافه کردن خط زیر برای پشتیبان‌گیری روزانه در ساعت 2 بامداد:

```
0 2 * * * /var/www/hiroestate/backup.sh
```

## ۷. امنیت بیشتر

برای امنیت بیشتر، می‌توانید اقدامات زیر را انجام دهید:

- نصب و پیکربندی Let's Encrypt برای HTTPS
- نصب و پیکربندی Fail2ban برای محافظت در برابر حملات Brute Force
- محدود کردن دسترسی SSH
- تنظیم فایروال با UFW یا iptables

## ۸. رفع مشکلات متداول

### خطای دسترسی به دیتابیس
- بررسی صحت اطلاعات اتصال در فایل `.env`
- بررسی دسترسی‌های کاربر دیتابیس

### خطای نمایش تصاویر
- بررسی دسترسی‌های پوشه `media`
- اطمینان از پیکربندی صحیح NGINX برای فایل‌های استاتیک و رسانه

### خطای 500 (خطای سرور)
- بررسی لاگ‌های Gunicorn و Nginx در `/var/log/`

## ۹. به‌روزرسانی سیستم

برای به‌روزرسانی سیستم به نسخه جدیدتر:

```bash
# روش دستی
cd /var/www/hiroestate
source venv/bin/activate
git pull  # اگر از گیت استفاده می‌کنید
pip install -r project_requirements.md
python manage.py migrate
python manage.py collectstatic --noinput
sudo systemctl restart hiroestate

# روش Docker
cd /path/to/project
git pull  # اگر از گیت استفاده می‌کنید
docker-compose build
docker-compose up -d
```

## نیاز به کمک بیشتر؟

اگر در هر مرحله از نصب با مشکلی مواجه شدید، می‌توانید از طریق ایمیل یا تلگرام با ما در تماس باشید.