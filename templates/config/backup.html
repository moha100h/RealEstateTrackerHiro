{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    /* === استایل اصلی صفحه === */
    .page-container {
        padding: 2rem 0;
    }
    
    .section-title {
        display: inline-flex;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .section-title-icon {
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #4481eb 0%, #04befe 100%);
        color: white;
        border-radius: 12px;
        margin-left: 1rem;
        box-shadow: 0 4px 15px rgba(68, 129, 235, 0.2);
    }
    
    .section-title-text {
        margin: 0;
    }
    
    .backup-description {
        color: #6c757d;
        margin-bottom: 2rem;
        max-width: 800px;
    }
    
    /* === کارت ها و تب ها === */
    .backup-tabs {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        background-color: white;
        margin-bottom: 2rem;
    }
    
    .backup-tabs-header {
        display: flex;
        border-bottom: 1px solid #f1f1f1;
        overflow-x: auto;
        scrollbar-width: none; /* برای Firefox */
    }
    
    .backup-tabs-header::-webkit-scrollbar {
        display: none; /* برای Chrome و Safari */
    }
    
    .backup-tab {
        padding: 1.2rem 1.5rem;
        cursor: pointer;
        white-space: nowrap;
        font-weight: 600;
        color: #495057;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .backup-tab:hover {
        color: #4481eb;
        background-color: rgba(68, 129, 235, 0.05);
    }
    
    .backup-tab.active {
        color: #4481eb;
        border-bottom-color: #4481eb;
        background-color: rgba(68, 129, 235, 0.08);
    }
    
    .backup-tabs-content {
        padding: 2rem;
    }
    
    .backup-tab-pane {
        display: none;
    }
    
    .backup-tab-pane.active {
        display: block;
    }
    
    /* === کارت های اطلاعات و پشتیبان === */
    .backup-panel {
        border-radius: 15px;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }
    
    .backup-panel:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .backup-panel-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
        align-items: center;
    }
    
    .backup-panel-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 1rem;
    }
    
    .backup-panel-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .backup-panel-subtitle {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .backup-panel-body {
        padding: 2rem;
    }
    
    .backup-panel-footer {
        padding: 1.25rem 2rem;
        border-top: 1px solid #f1f1f1;
        background-color: #f8f9fa;
    }
    
    /* === انواع پنل ها === */
    .panel-primary .backup-panel-icon {
        background: linear-gradient(135deg, #4481eb 0%, #04befe 100%);
        color: white;
    }
    
    .panel-success .backup-panel-icon {
        background: linear-gradient(135deg, #20c997 0%, #198754 100%);
        color: white;
    }
    
    .panel-danger .backup-panel-icon {
        background: linear-gradient(135deg, #ff6b6b 0%, #dc3545 100%);
        color: white;
    }
    
    .panel-warning .backup-panel-icon {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
    }
    
    .panel-info .backup-panel-icon {
        background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%);
        color: white;
    }
    
    /* === ویژگی های پشتیبان === */
    .backup-features {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
    }
    
    .backup-feature {
        background-color: white;
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid #f1f1f1;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .backup-feature:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border-color: rgba(68, 129, 235, 0.3);
    }
    
    .backup-feature-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.25rem;
        background-color: #f8f9fa;
        color: #4481eb;
        font-size: 1.5rem;
    }
    
    .backup-feature-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    
    .backup-feature-text {
        font-size: 0.95rem;
        color: #6c757d;
        margin-bottom: 0;
    }
    
    /* === اکسپورت و فرمت ها === */
    .export-formats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
    }
    
    .export-format {
        background-color: white;
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid #f1f1f1;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .export-format:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border-color: rgba(68, 129, 235, 0.3);
    }
    
    .export-format-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.25rem;
        font-size: 2rem;
    }
    
    .export-format-excel .export-format-icon {
        background-color: rgba(25, 135, 84, 0.15);
        color: #198754;
    }
    
    .export-format-zip .export-format-icon {
        background-color: rgba(13, 110, 253, 0.15);
        color: #0d6efd;
    }
    
    .export-format-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .export-format-subtitle {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    /* === تاریخچه پشتیبان گیری === */
    .backup-history-table {
        width: 100%;
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .backup-history-table th {
        background-color: #f9fafb;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        padding: 1rem 1.5rem;
        color: #495057;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #f1f1f1;
    }
    
    .backup-history-table td {
        padding: 1rem 1.5rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f1f1;
    }
    
    .backup-history-table tr:last-child td {
        border-bottom: none;
    }
    
    .backup-history-table tr:hover {
        background-color: rgba(68, 129, 235, 0.05);
    }
    
    .file-size-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        background-color: rgba(108, 117, 125, 0.15);
        color: #6c757d;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
    
    /* === بخش اطلاعات و راهنما === */
    .backup-info-panel {
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
    }
    
    .backup-info-title {
        display: flex;
        align-items: center;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #343a40;
        gap: 0.5rem;
    }
    
    .backup-info-list {
        list-style-type: none;
        padding: 0;
        margin-bottom: 0;
    }
    
    .backup-info-list li {
        position: relative;
        padding-right: 1.75rem;
        margin-bottom: 0.75rem;
        color: #495057;
    }
    
    .backup-info-list li::before {
        content: "";
        position: absolute;
        right: 0;
        top: 0.5rem;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4481eb;
    }
    
    .backup-info-list li:last-child {
        margin-bottom: 0;
    }
    
    /* === دکمه ها === */
    .btn-upload {
        border-radius: 50px;
        padding: 0.5rem 1.25rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }
    
    .btn-upload:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn-download {
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        box-shadow: 0 4px 10px rgba(68, 129, 235, 0.2);
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }
    
    .btn-download:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(68, 129, 235, 0.3);
    }
    
    /* === نمودار و آمار === */
    .backup-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .backup-stat {
        background-color: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .backup-stat:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .backup-stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: rgba(68, 129, 235, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: #4481eb;
    }
    
    .backup-stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
        color: #343a40;
    }
    
    .backup-stat-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    /* === فرم آپلود و بازیابی === */
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }
    
    .file-upload-area:hover {
        border-color: #4481eb;
        background-color: rgba(68, 129, 235, 0.03);
    }
    
    .file-upload-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: rgba(68, 129, 235, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        color: #4481eb;
        font-size: 2rem;
    }
    
    .file-upload-text {
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #343a40;
    }
    
    .file-upload-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .file-upload-input {
        position: absolute;
        width: 0;
        height: 0;
        opacity: 0;
    }
    
    .selected-file {
        display: none;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 10px;
        margin-top: 1rem;
    }
    
    .selected-file-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .selected-file-size {
        font-size: 0.85rem;
        color: #6c757d;
    }

    /* === توست و نوتیفیکیشن === */
    .custom-toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background-color: white;
        border-radius: 10px;
        padding: 1rem 1.5rem;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 1rem;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        z-index: 1050;
    }
    
    .custom-toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .toast-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .toast-success .toast-icon {
        background-color: rgba(25, 135, 84, 0.15);
        color: #198754;
    }
    
    .toast-error .toast-icon {
        background-color: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }
    
    .toast-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .toast-message {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0;
    }
    
    @media (max-width: 768px) {
        .backup-stats, 
        .backup-features,
        .export-formats {
            grid-template-columns: 1fr;
        }
        
        .backup-panel-header {
            flex-direction: column;
            text-align: center;
        }
        
        .backup-panel-icon {
            margin-left: 0;
            margin-bottom: 1rem;
        }
        
        .file-upload-area {
            padding: 1.5rem;
        }
        
        .file-upload-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container page-container">
    <!-- نوار مسیر (Breadcrumb) -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">خانه</a></li>
                <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">داشبورد</a></li>
                <li class="breadcrumb-item active">پشتیبان‌گیری و بازیابی</li>
            </ol>
        </nav>
    </div>
    
    <!-- عنوان صفحه -->
    <div class="section-title mb-4">
        <div class="section-title-icon">
            <i class="bi bi-database-fill"></i>
        </div>
        <div>
            <h2 class="section-title-text">پشتیبان‌گیری و بازیابی سیستم</h2>
            <p class="text-muted mb-0">مدیریت داده‌های سیستم و تهیه نسخه پشتیبان</p>
        </div>
    </div>
    
    <!-- پیام‌های سیستم -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} d-flex" role="alert">
            <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% else %}bi-exclamation-circle-fill{% endif %} me-2 fs-5"></i>
            <div>{{ message }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="row mt-4 gx-4">
        <!-- منو و راهنما -->
        <div class="col-lg-3 mb-4">
            <!-- تب‌های منو -->
            <div class="backup-panel mb-4">
                <div class="list-group list-group-flush">
                    <a href="#backup-section" class="list-group-item list-group-item-action active d-flex align-items-center" data-bs-toggle="tab">
                        <i class="bi bi-cloud-arrow-down me-3 fs-5"></i>
                        <div>
                            <div class="fw-bold">پشتیبان‌گیری</div>
                            <div class="small text-muted">ایجاد نسخه پشتیبان از داده‌ها</div>
                        </div>
                    </a>
                    <a href="#restore-section" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">
                        <i class="bi bi-cloud-arrow-up me-3 fs-5"></i>
                        <div>
                            <div class="fw-bold">بازیابی اطلاعات</div>
                            <div class="small text-muted">بازگرداندن داده‌ها از نسخه پشتیبان</div>
                        </div>
                    </a>
                    <a href="#export-section" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">
                        <i class="bi bi-file-earmark-spreadsheet me-3 fs-5"></i>
                        <div>
                            <div class="fw-bold">خروجی اکسل</div>
                            <div class="small text-muted">دریافت اطلاعات به فرمت اکسل</div>
                        </div>
                    </a>
                    <a href="#history-section" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="tab">
                        <i class="bi bi-clock-history me-3 fs-5"></i>
                        <div>
                            <div class="fw-bold">تاریخچه</div>
                            <div class="small text-muted">مشاهده سوابق پشتیبان‌گیری</div>
                        </div>
                    </a>
                </div>
            </div>
            
            <!-- راهنما و توصیه‌های امنیتی -->
            <div class="backup-info-panel">
                <h6 class="backup-info-title">
                    <i class="bi bi-shield-lock fs-5 me-2"></i>
                    توصیه‌های امنیتی
                </h6>
                <ul class="backup-info-list">
                    <li>هر هفته از اطلاعات خود پشتیبان تهیه کنید</li>
                    <li>فایل‌های پشتیبان را در چند مکان مختلف نگهداری کنید</li>
                    <li>هنگام بازیابی، از وارد کردن فایل‌های نامعتبر خودداری کنید</li>
                    <li>خروجی اکسل را برای دسترسی سریع به اطلاعات در مواقع اضطراری ذخیره کنید</li>
                    <li>بعد از به‌روزرسانی سیستم حتماً یک نسخه پشتیبان جدید تهیه کنید</li>
                </ul>
            </div>
        </div>
        
        <!-- محتوای اصلی -->
        <div class="col-lg-9">
            <div class="tab-content">
                <!-- بخش پشتیبان‌گیری -->
                <div class="tab-pane fade show active" id="backup-section">
                    <!-- کارت آمار -->
                    <div class="backup-stats">
                        <div class="backup-stat">
                            <div class="backup-stat-icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="backup-stat-value">{{ total_properties|default:"0" }}</div>
                            <div class="backup-stat-label">کل املاک</div>
                        </div>
                        <div class="backup-stat">
                            <div class="backup-stat-icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="backup-stat-value">{{ total_users|default:"0" }}</div>
                            <div class="backup-stat-label">تعداد کاربران</div>
                        </div>
                        <div class="backup-stat">
                            <div class="backup-stat-icon">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <div class="backup-stat-value">{{ total_backups|default:"0" }}</div>
                            <div class="backup-stat-label">پشتیبان‌های قبلی</div>
                        </div>
                    </div>
                    
                    <!-- کارت پشتیبان‌گیری -->
                    <div class="backup-panel panel-primary">
                        <div class="backup-panel-header">
                            <div class="backup-panel-icon">
                                <i class="bi bi-cloud-arrow-down fs-4"></i>
                            </div>
                            <div>
                                <h4 class="backup-panel-title">ایجاد نسخه پشتیبان</h4>
                                <p class="backup-panel-subtitle">پشتیبان‌گیری از تمامی داده‌ها و فایل‌های سیستم</p>
                            </div>
                        </div>
                        <div class="backup-panel-body">
                            <div class="row">
                                <div class="col-lg-7">
                                    <h5 class="mb-4">پشتیبان‌گیری کامل سیستم</h5>
                                    <p class="text-muted">
                                        با ایجاد نسخه پشتیبان، تمامی اطلاعات سیستم شامل داده‌های املاک، کاربران، تنظیمات و فایل‌های رسانه در قالب یک فایل فشرده ذخیره می‌شود. این فایل را می‌توانید بعداً برای بازیابی کامل سیستم استفاده کنید.
                                    </p>
                                    
                                    <div class="backup-features">
                                        <div class="backup-feature">
                                            <div class="backup-feature-icon">
                                                <i class="bi bi-shield-fill-check"></i>
                                            </div>
                                            <h6 class="backup-feature-title">امنیت پیشرفته</h6>
                                            <p class="backup-feature-text">
                                                فایل‌های پشتیبان با استفاده از مکانیزم‌های امنیتی پیشرفته ایجاد می‌شوند تا از داده‌های شما محافظت شود.
                                            </p>
                                        </div>
                                        <div class="backup-feature">
                                            <div class="backup-feature-icon">
                                                <i class="bi bi-speedometer2"></i>
                                            </div>
                                            <h6 class="backup-feature-title">سرعت بالا</h6>
                                            <p class="backup-feature-text">
                                                الگوریتم‌های بهینه‌سازی شده برای ایجاد سریع نسخه پشتیبان حتی از حجم زیادی از داده‌ها.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <form method="post" action="{% url 'config:create_backup' %}" class="mt-4">
                                        {% csrf_token %}
                                        
                                        <div class="row mb-4">
                                            <div class="col-md-6 mb-3">
                                                <label for="backup_type" class="form-label fw-bold">نوع پشتیبان‌گیری:</label>
                                                <select name="backup_type" id="backup_type" class="form-select">
                                                    <option value="full" selected>پشتیبان کامل (داده‌ها و فایل‌ها)</option>
                                                    <option value="data_only">فقط داده‌ها (بدون فایل‌های مدیا)</option>
                                                    <option value="media_only">فقط فایل‌های مدیا</option>
                                                    <option value="config_only">فقط تنظیمات سیستم</option>
                                                </select>
                                                <div class="form-text">نوع پشتیبان را بر اساس نیاز خود انتخاب کنید.</div>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="compression_level" class="form-label fw-bold">سطح فشرده‌سازی:</label>
                                                <div class="d-flex align-items-center">
                                                    <input type="range" class="form-range" name="compression_level" id="compression_level" min="1" max="9" value="9">
                                                    <span class="ms-2 fw-bold" id="compression_level_display">9</span>
                                                </div>
                                                <div class="form-text">مقدار بالاتر = حجم کمتر، اما زمان پشتیبان‌گیری بیشتر</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="backup_description" class="form-label fw-bold">توضیحات پشتیبان (اختیاری):</label>
                                            <textarea name="backup_description" id="backup_description" class="form-control" rows="3" placeholder="توضیحات خود را برای این پشتیبان وارد کنید..."></textarea>
                                            <div class="form-text">توضیحات می‌تواند شامل هدف پشتیبان‌گیری یا تغییرات مهم سیستم باشد.</div>
                                        </div>
                                        
                                        <div class="d-flex align-items-center">
                                            <button type="submit" class="btn btn-primary btn-download">
                                                <i class="bi bi-download me-2"></i>
                                                ایجاد و دانلود پشتیبان
                                            </button>
                                            <div class="form-text me-3">
                                                <i class="bi bi-info-circle me-1"></i> 
                                                فایل پشتیبان به صورت خودکار دانلود خواهد شد.
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="col-lg-5">
                                    <div class="text-center mt-4">
                                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%234481eb' opacity='0.8'%3E%3Cpath d='M464 352H48c-26.51 0-48 21.49-48 48v32c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48v-32c0-26.51-21.49-48-48-48zm-80 48c13.255 0 24 10.745 24 24s-10.745 24-24 24-24-10.745-24-24 10.745-24 24-24zm128 0c13.255 0 24 10.745 24 24s-10.745 24-24 24-24-10.745-24-24 10.745-24 24-24zm-180.444-281.664c2.18 5.22 8.134 7.684 13.356 5.502l40.512-16.945c5.22-2.18 7.684-8.136 5.502-13.356-2.182-5.22-8.134-7.684-13.356-5.502l-40.512 16.945c-5.22 2.182-7.684 8.136-5.502 13.356zm93.513-92.92c19.627 0 35.556 15.93 35.556 35.556 0 19.627-15.929 35.556-35.556 35.556S248.89 80.6 248.89 60.973c0-19.627 15.929-35.556 35.556-35.556zm91.51 92.92c2.182-5.22-.282-11.175-5.502-13.357l-40.512-16.945c-5.224-2.183-11.175.282-13.356 5.502-2.182 5.22.282 11.175 5.502 13.357l40.512 16.945c5.218 2.179 11.174-.285 13.356-5.502zM256 8c22.056 0 40 17.944 40 40s-17.944 40-40 40-40-17.944-40-40 17.944-40 40-40zm-88.89 52.973c0-19.627 15.929-35.556 35.556-35.556 19.627 0 35.556 15.93 35.556 35.556 0 19.627-15.929 35.556-35.556 35.556-19.627 0-35.556-15.93-35.556-35.556zm-79.067 26.336l40.512 16.945c5.222 2.184 11.175-.282 13.356-5.502 2.182-5.22-.282-11.175-5.502-13.357L96.398 68.45c-5.222-2.184-11.175.282-13.356 5.502-2.182 5.221.282 11.176 5.502 13.357zm26.336 79.067l16.945-40.512c2.182-5.22-.282-11.175-5.502-13.357-5.22-2.182-11.175.282-13.356 5.502l-16.945 40.512c-2.182 5.22.282 11.175 5.502 13.357 5.22 2.18 11.174-.282 13.356-5.502zM88 256c0-4.862 3.952-8.813 8.814-8.813h17.628c4.862 0 8.814 3.952 8.814 8.813 0 4.861-3.952 8.813-8.814 8.813H96.814c-4.862 0-8.814-3.952-8.814-8.813zm180.814 8.813h-17.628c-4.862 0-8.814-3.952-8.814-8.813 0-4.861 3.952-8.813 8.814-8.813h17.628c4.862 0 8.814 3.952 8.814 8.813 0 4.861-3.952 8.813-8.814 8.813zm64.186 0h-17.628c-4.862 0-8.814-3.952-8.814-8.813 0-4.861 3.952-8.813 8.814-8.813h17.628c4.862 0 8.814 3.952 8.814 8.813 0 4.861-3.952 8.813-8.814 8.813zm64.185 0h-17.628c-4.862 0-8.814-3.952-8.814-8.813 0-4.861 3.952-8.813 8.814-8.813h17.628c4.862 0 8.814 3.952 8.814 8.813 0 4.861-3.952 8.813-8.814 8.813zm8.215 151.607c-6.259-5.826-16.078-5.523-21.91.728-17.234 18.445-36.646 32.361-58.178 41.342-21.52 8.976-44.757 13.534-70 13.534-25.242 0-48.48-4.559-70-13.534-21.532-8.98-40.944-22.897-58.178-41.342-5.832-6.251-15.651-6.554-21.91-.728-6.26 5.826-6.554 15.651-.73 21.913 21.338 22.857 46.089 40.093 74.324 51.664C153.727 503.294 182.744 512 196 512h120c13.256 0 42.272-8.706 89.552-28.574 28.236-11.57 52.988-28.806 74.324-51.664 5.827-6.262 5.532-16.087-.728-21.913z'/%3E%3C/svg%3E" width="250" height="250" alt="Database Backup" class="img-fluid">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- بخش بازیابی اطلاعات -->
                <div class="tab-pane fade" id="restore-section">
                    <div class="backup-panel panel-danger">
                        <div class="backup-panel-header">
                            <div class="backup-panel-icon">
                                <i class="bi bi-cloud-arrow-up fs-4"></i>
                            </div>
                            <div>
                                <h4 class="backup-panel-title">بازیابی اطلاعات از پشتیبان</h4>
                                <p class="backup-panel-subtitle">بازگرداندن سیستم به وضعیت قبلی از فایل پشتیبان</p>
                            </div>
                        </div>
                        <div class="backup-panel-body">
                            <div class="alert alert-danger d-flex" role="alert">
                                <div class="d-flex align-items-center me-3">
                                    <i class="bi bi-exclamation-triangle-fill fs-3"></i>
                                </div>
                                <div>
                                    <h5 class="alert-heading">هشدار: این عملیات غیر قابل بازگشت است!</h5>
                                    <p class="mb-0">بازیابی از پشتیبان، تمام اطلاعات فعلی را با اطلاعات موجود در فایل پشتیبان جایگزین می‌کند. پیش از انجام این کار، حتماً از داده‌های فعلی خود پشتیبان بگیرید.</p>
                                </div>
                            </div>
                            
                            <form method="post" action="{% url 'config:restore_backup' %}" enctype="multipart/form-data" class="mt-4" id="restoreForm">
                                {% csrf_token %}
                                <div class="file-upload-area" id="fileUploadArea">
                                    <input type="file" name="backup_file" id="backupFile" class="file-upload-input" accept=".zip">
                                    <div class="file-upload-icon">
                                        <i class="bi bi-cloud-upload"></i>
                                    </div>
                                    <h5 class="file-upload-text">فایل پشتیبان را انتخاب کنید یا اینجا رها کنید</h5>
                                    <p class="file-upload-info">فرمت مجاز: ZIP - حداکثر سایز: 200 مگابایت</p>
                                </div>
                                
                                <div class="form-check form-switch my-3">
                                    <input class="form-check-input" type="checkbox" name="clean_media" id="cleanMedia" checked>
                                    <label class="form-check-label" for="cleanMedia">حذف فایل‌های مدیای موجود قبل از بازیابی</label>
                                    <div class="form-text">در صورت فعال بودن، فایل‌های مدیای فعلی حذف و با فایل‌های موجود در پشتیبان جایگزین می‌شوند.</div>
                                </div>
                                
                                <div id="selectedFileInfo" class="selected-file">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="selected-file-name" id="selectedFileName"></div>
                                            <div class="selected-file-size" id="selectedFileSize"></div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="removeFileBtn">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="backup-features mt-4">
                                    <div class="backup-feature">
                                        <div class="backup-feature-icon">
                                            <i class="bi bi-check2-circle"></i>
                                        </div>
                                        <h6 class="backup-feature-title">بازیابی کامل</h6>
                                        <p class="backup-feature-text">
                                            تمام داده‌ها و تنظیمات سیستم به حالت زمان پشتیبان‌گیری بازگردانده می‌شود.
                                        </p>
                                    </div>
                                    <div class="backup-feature">
                                        <div class="backup-feature-icon">
                                            <i class="bi bi-images"></i>
                                        </div>
                                        <h6 class="backup-feature-title">بازیابی فایل‌ها</h6>
                                        <p class="backup-feature-text">
                                            تصاویر و سایر فایل‌های رسانه‌ای نیز از فایل پشتیبان استخراج و جایگزین می‌شوند.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-danger btn-download" id="restoreBtn" disabled>
                                        <i class="bi bi-arrow-repeat me-2"></i>
                                        بازیابی سیستم از پشتیبان
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- بخش خروجی اکسل -->
                <div class="tab-pane fade" id="export-section">
                    <div class="backup-panel panel-success">
                        <div class="backup-panel-header">
                            <div class="backup-panel-icon">
                                <i class="bi bi-file-earmark-spreadsheet fs-4"></i>
                            </div>
                            <div>
                                <h4 class="backup-panel-title">خروجی اکسل</h4>
                                <p class="backup-panel-subtitle">دریافت اطلاعات سیستم به فرمت اکسل</p>
                            </div>
                        </div>
                        <div class="backup-panel-body">
                            <div class="row">
                                <div class="col-lg-7">
                                    <h5 class="mb-4">خروجی داده‌های سیستم</h5>
                                    <p class="text-muted">
                                        برای دسترسی سریع به اطلاعات یا انجام تحلیل‌های پیشرفته، می‌توانید داده‌های مورد نیاز خود را به فرمت اکسل دریافت کنید. این فایل‌ها برای مقاصد گزارش‌گیری یا پشتیبان نگهداری ایجاد می‌شوند.
                                    </p>
                                    
                                    <div class="export-formats">
                                        <a href="{% url 'config:export_properties_excel' %}" class="export-format export-format-excel">
                                            <div class="export-format-icon">
                                                <i class="bi bi-building"></i>
                                            </div>
                                            <h6 class="export-format-title">خروجی املاک</h6>
                                            <p class="export-format-subtitle">لیست کامل املاک با جزئیات</p>
                                        </a>
                                        <a href="{% url 'config:export_data_excel' %}" class="export-format export-format-excel">
                                            <div class="export-format-icon">
                                                <i class="bi bi-table"></i>
                                            </div>
                                            <h6 class="export-format-title">خروجی جامع</h6>
                                            <p class="export-format-subtitle">اطلاعات سیستم و تنظیمات</p>
                                        </a>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="text-center mt-4">
                                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23198754' opacity='0.8'%3E%3Cpath d='M464 128H272V48c0-26.51-21.49-48-48-48H48C21.49 0 0 21.49 0 48v320c0 26.51 21.49 48 48 48h144v40c0 13.255 10.745 24 24 24h240c13.255 0 24-10.745 24-24V152c0-13.255-10.745-24-24-24zM362 416H250v-88c0-6.627-5.373-12-12-12h-88V48h212v80c0 6.627 5.373 12 12 12h88v276zm56-224h-40v40c0 6.627-5.373 12-12 12s-12-5.373-12-12v-40h-40c-6.627 0-12-5.373-12-12s5.373-12 12-12h40v-40c0-6.627 5.373-12 12-12s12 5.373 12 12v40h40c6.627 0 12 5.373 12 12s-5.373 12-12 12z'/%3E%3C/svg%3E" width="200" height="200" alt="Excel Export" class="img-fluid">
                                    </div>
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <div class="mt-4">
                                <h5 class="mb-3">مزایای استفاده از خروجی اکسل</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex align-items-center border-0 px-0">
                                                <i class="bi bi-check2-circle text-success me-3 fs-5"></i>
                                                <span>انجام تحلیل‌های آماری پیشرفته</span>
                                            </li>
                                            <li class="list-group-item d-flex align-items-center border-0 px-0">
                                                <i class="bi bi-check2-circle text-success me-3 fs-5"></i>
                                                <span>ایجاد نمودارها و داشبوردهای سفارشی</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex align-items-center border-0 px-0">
                                                <i class="bi bi-check2-circle text-success me-3 fs-5"></i>
                                                <span>به‌اشتراک‌گذاری ساده اطلاعات با همکاران</span>
                                            </li>
                                            <li class="list-group-item d-flex align-items-center border-0 px-0">
                                                <i class="bi bi-check2-circle text-success me-3 fs-5"></i>
                                                <span>پشتیبان سبک از داده‌ها در مواقع بحرانی</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- بخش تاریخچه -->
                <div class="tab-pane fade" id="history-section">
                    <div class="backup-panel panel-info">
                        <div class="backup-panel-header">
                            <div class="backup-panel-icon">
                                <i class="bi bi-clock-history fs-4"></i>
                            </div>
                            <div>
                                <h4 class="backup-panel-title">تاریخچه پشتیبان‌گیری</h4>
                                <p class="backup-panel-subtitle">سوابق عملیات پشتیبان‌گیری ثبت شده در سیستم</p>
                            </div>
                        </div>
                        <div class="backup-panel-body">
                            <div class="table-responsive">
                                <table class="backup-history-table">
                                    <thead>
                                        <tr>
                                            <th>نام فایل</th>
                                            <th>نوع پشتیبان</th>
                                            <th>تاریخ ایجاد</th>
                                            <th>حجم فایل</th>
                                            <th>ایجاد کننده</th>
                                            <th>توضیحات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for backup in backups %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-file-earmark-zip text-primary me-2"></i>
                                                    <span>{{ backup.file_name }}</span>
                                                    {% if backup.checksum %}
                                                    <span class="ms-2" data-bs-toggle="tooltip" title="فایل دارای چک‌سام برای بررسی سلامت">
                                                        <i class="bi bi-shield-check text-success"></i>
                                                    </span>
                                                    {% endif %}
                                                    {% if backup.is_encrypted %}
                                                    <span class="ms-2" data-bs-toggle="tooltip" title="فایل رمزنگاری شده است">
                                                        <i class="bi bi-lock-fill text-warning"></i>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if backup.backup_type == 'full' %}
                                                <span class="badge bg-primary">پشتیبان کامل</span>
                                                {% elif backup.backup_type == 'data_only' %}
                                                <span class="badge bg-info">فقط داده‌ها</span>
                                                {% elif backup.backup_type == 'media_only' %}
                                                <span class="badge bg-warning">فقط فایل‌ها</span>
                                                {% elif backup.backup_type == 'config_only' %}
                                                <span class="badge bg-secondary">فقط تنظیمات</span>
                                                {% else %}
                                                <span class="badge bg-dark">{{ backup.backup_type }}</span>
                                                {% endif %}
                                                
                                                {% if backup.compression_level %}
                                                <span class="ms-1 small text-muted" data-bs-toggle="tooltip" title="سطح فشرده‌سازی">
                                                    <i class="bi bi-arrows-collapse"></i> {{ backup.compression_level }}
                                                </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div>{{ backup.created_at|date:"Y/m/d - H:i" }}</div>
                                                <small class="text-muted">{{ backup.get_backup_age }}</small>
                                            </td>
                                            <td>
                                                <span class="file-size-badge">
                                                    <i class="bi bi-file-earmark-zip me-1"></i>
                                                    {{ backup.get_file_size_display }}
                                                </span>
                                            </td>
                                            <td>{{ backup.created_by.get_full_name|default:backup.created_by.username }}</td>
                                            <td>
                                                {% if backup.description %}
                                                <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                                                      data-bs-toggle="tooltip" title="{{ backup.description }}">
                                                    {{ backup.description }}
                                                </span>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center py-5">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="bi bi-inbox text-muted mb-3" style="font-size: 3rem;"></i>
                                                    <h5 class="mb-2">هیچ سابقه پشتیبان‌گیری یافت نشد</h5>
                                                    <p class="text-muted mb-3">برای ایجاد اولین نسخه پشتیبان، به بخش پشتیبان‌گیری مراجعه کنید</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- اسکریپت‌های مورد نیاز -->
<script>
    // اسکریپت برای تب‌ها
    document.addEventListener('DOMContentLoaded', function() {
        const tabLinks = document.querySelectorAll('.list-group-item-action');
        const tabContents = document.querySelectorAll('.tab-pane');
        
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // فعال کردن تب انتخاب شده
                tabLinks.forEach(item => item.classList.remove('active'));
                this.classList.add('active');
                
                // نمایش محتوای مربوطه
                const targetId = this.getAttribute('href').substring(1);
                tabContents.forEach(content => {
                    content.classList.remove('show', 'active');
                    if (content.id === targetId) {
                        content.classList.add('show', 'active');
                    }
                });
            });
        });
        
        // اسکریپت برای آپلود فایل
        const fileUploadArea = document.getElementById('fileUploadArea');
        const backupFile = document.getElementById('backupFile');
        const selectedFileInfo = document.getElementById('selectedFileInfo');
        const selectedFileName = document.getElementById('selectedFileName');
        const selectedFileSize = document.getElementById('selectedFileSize');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        
        if (fileUploadArea) {
            fileUploadArea.addEventListener('click', () => {
                backupFile.click();
            });
            
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('border-primary');
            });
            
            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('border-primary');
            });
            
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('border-primary');
                
                if (e.dataTransfer.files.length > 0) {
                    backupFile.files = e.dataTransfer.files;
                    updateFileInfo();
                }
            });
            
            backupFile.addEventListener('change', updateFileInfo);
            
            removeFileBtn.addEventListener('click', () => {
                backupFile.value = '';
                selectedFileInfo.style.display = 'none';
                restoreBtn.disabled = true;
            });
            
            function updateFileInfo() {
                if (backupFile.files.length > 0) {
                    const file = backupFile.files[0];
                    
                    // بررسی پسوند فایل
                    if (!file.name.toLowerCase().endsWith('.zip')) {
                        showToast('خطا در انتخاب فایل', 'فقط فایل‌های با پسوند ZIP مجاز هستند.', 'error');
                        backupFile.value = '';
                        return;
                    }
                    
                    // بررسی سایز فایل (محدودیت 100 مگابایت)
                    const maxSize = 100 * 1024 * 1024; // 100 MB
                    if (file.size > maxSize) {
                        showToast('خطا در انتخاب فایل', 'سایز فایل بیشتر از حد مجاز (100 مگابایت) است.', 'error');
                        backupFile.value = '';
                        return;
                    }
                    
                    selectedFileName.textContent = file.name;
                    
                    // نمایش سایز فایل به صورت خوانا
                    let fileSize;
                    if (file.size < 1024) {
                        fileSize = file.size + ' بایت';
                    } else if (file.size < 1024 * 1024) {
                        fileSize = (file.size / 1024).toFixed(1) + ' کیلوبایت';
                    } else {
                        fileSize = (file.size / (1024 * 1024)).toFixed(1) + ' مگابایت';
                    }
                    
                    selectedFileSize.textContent = fileSize;
                    selectedFileInfo.style.display = 'block';
                    restoreBtn.disabled = false;
                }
            }
        }
        
        // اسکریپت برای توست نوتیفیکیشن
        function showToast(title, message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `custom-toast toast-${type}`;
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-circle-fill'}"></i>
                </div>
                <div>
                    <h6 class="toast-title">${title}</h6>
                    <p class="toast-message">${message}</p>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 5000);
        }
    });
</script>
{% endblock %}