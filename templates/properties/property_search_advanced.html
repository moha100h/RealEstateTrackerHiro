{% extends 'base.html' %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css">
<style>
    :root {
        --primary-color: #4A6CF7;
        --primary-dark: #2651E9;
        --primary-gradient: linear-gradient(45deg, #4A6CF7, #2651E9);
        --primary-gradient-hover: linear-gradient(45deg, #2651E9, #1a3fcb);
        --secondary-color: #6c757d;
        --success-color: #38cb89;
        --danger-color: #ff5630;
        --warning-color: #ffab00;
        --info-color: #0dcaf0;
        --text-primary: #2b3445;
        --text-secondary: #546e7a;
        --text-muted: #7d879c;
        --border-light: #e0e0e0;
        --background-light: #f8fafc;
        --background-darker: #eceff1;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.07);
        --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.1);
        --border-radius-sm: 6px;
        --border-radius-md: 8px;
        --border-radius-lg: 12px;
        --border-radius-round: 50px;
        --transition-fast: all 0.2s ease;
        --transition-normal: all 0.3s ease;
        --transition-slow: all 0.5s ease;
        --transition-bounce: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    
    body {
        background-color: var(--background-light);
    }
    
    .search-container {
        min-height: calc(100vh - 70px);
    }
    
    /* هدر جستجو */
    .search-header {
        background: var(--primary-gradient);
        padding: 3rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(38, 81, 233, 0.1);
        position: relative;
        overflow: hidden;
        border-radius: 0 0 30px 30px;
    }
    
    .search-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 60%);
        opacity: 0.4;
    }
    
    .search-title {
        color: white;
        font-weight: 700;
        margin-bottom: 1.5rem;
        position: relative;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .search-subtitle {
        color: rgba(255,255,255,0.9);
        margin-bottom: 2rem;
        font-size: 1.1rem;
        position: relative;
    }
    
    .search-bar {
        background: white;
        border-radius: var(--border-radius-round);
        display: flex;
        align-items: center;
        padding: 0.5rem 0.5rem 0.5rem 1.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        position: relative;
        z-index: 10;
        transition: var(--transition-normal);
    }
    
    .search-input {
        flex-grow: 1;
        border: none;
        padding: 0.8rem 1rem;
        font-size: 1rem;
        background: transparent;
    }
    
    .search-input:focus {
        outline: none;
    }
    
    .search-button {
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: var(--border-radius-round);
        padding: 0.8rem 1.8rem;
        font-weight: 600;
        transition: var(--transition-normal);
        box-shadow: 0 4px 15px rgba(38, 81, 233, 0.25);
    }
    
    .search-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(38, 81, 233, 0.3);
        background: var(--primary-gradient-hover);
    }
    
    .search-button i {
        margin-left: 0.5rem;
    }
    
    .filter-toggle {
        background: rgba(255,255,255,0.15);
        color: white;
        border: none;
        border-radius: var(--border-radius-round);
        padding: 0.5rem 1.2rem;
        margin-top: 1rem;
        font-size: 0.9rem;
        font-weight: 500;
        transition: var(--transition-normal);
        backdrop-filter: blur(4px);
    }
    
    .filter-toggle:hover {
        background: rgba(255,255,255,0.25);
        transform: translateY(-2px);
    }
    
    .filter-toggle i {
        margin-left: 0.5rem;
    }
    
    /* Main content container */
    .content-container {
        padding: 2rem 0 4rem 0;
    }
    
    /* فیلترهای پیشرفته */
    .advanced-filters {
        background: white;
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        transition: var(--transition-normal);
        height: fit-content;
        border: 1px solid rgba(0,0,0,0.03);
    }
    
    .filter-header {
        background: var(--primary-gradient);
        color: white;
        padding: 1.2rem 1.5rem;
        border-bottom: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .filter-header h5 {
        margin-bottom: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .filter-header h5 i {
        margin-left: 0.7rem;
        font-size: 1.1rem;
    }
    
    .filter-header .collapse-toggle {
        cursor: pointer;
        width: 28px;
        height: 28px;
        background-color: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition-normal);
    }
    
    .filter-header .collapse-toggle:hover {
        background-color: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }
    
    .filter-body {
        padding: 1.5rem;
    }
    
    .filter-section {
        background-color: rgba(74, 108, 247, 0.03);
        border-radius: var(--border-radius-md);
        padding: 1.2rem;
        margin-bottom: 1.2rem;
    }
    
    .filter-section-title {
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 1rem;
        font-size: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(74, 108, 247, 0.1);
    }
    
    .filter-section-title i {
        margin-left: 0.7rem;
        color: var(--primary-color);
        font-size: 1.1rem;
    }
    
    /* اسلایدر قیمت و متراژ */
    .range-slider {
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    .range-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 0.8rem;
        color: var(--text-muted);
        font-size: 0.8rem;
    }
    
    .noUi-connect {
        background: var(--primary-gradient);
    }
    
    .noUi-horizontal {
        height: 6px;
    }
    
    .noUi-handle {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
        background: white;
        border: 2px solid var(--primary-color);
        top: -7px;
        right: -9px;
    }
    
    .noUi-handle:after, .noUi-handle:before {
        display: none;
    }
    
    /* نتایج */
    .results-container {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    
    .results-container.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    .search-stats {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.2rem 1.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0,0,0,0.03);
    }
    
    .search-stats-count {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .search-stats-count span {
        color: var(--primary-color);
        font-weight: 700;
    }
    
    .search-sort {
        display: flex;
        align-items: center;
    }
    
    .sort-label {
        margin-left: 0.5rem;
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    
    .sort-select {
        padding: 0.3rem 0.7rem;
        border-radius: var(--border-radius-md);
        border: 1px solid var(--border-light);
        font-size: 0.9rem;
        background-color: white;
    }
    
    /* فیلترهای فعال */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        gap: 0.5rem;
    }
    
    .filter-tag {
        background-color: rgba(74, 108, 247, 0.08);
        color: var(--primary-dark);
        padding: 0.4rem 0.9rem;
        border-radius: var(--border-radius-round);
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        transition: var(--transition-fast);
    }
    
    .filter-tag:hover {
        background-color: rgba(74, 108, 247, 0.12);
        transform: translateY(-2px);
    }
    
    .filter-tag i {
        margin-right: 0.5rem;
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    .clear-filters {
        background-color: rgba(255, 86, 48, 0.08);
        color: var(--danger-color);
        cursor: pointer;
    }
    
    .clear-filters:hover {
        background-color: rgba(255, 86, 48, 0.15);
    }
    
    /* Grid layout */
    .property-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.2rem;
    }
    
    /* کارت املاک */
    .property-card {
        position: relative;
        overflow: hidden;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-sm);
        background: white;
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: var(--transition-normal);
        transform: translateY(0);
        border: 1px solid rgba(0,0,0,0.03);
        max-height: 340px;
        animation: fadeInUp 0.5s ease forwards;
    }
    
    .property-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
        border-color: rgba(74, 108, 247, 0.1);
    }
    
    /* تصویر */
    .property-image-container {
        position: relative;
        padding-top: 56%;
        overflow: hidden;
    }
    
    .property-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s ease;
    }
    
    .property-card:hover .property-image {
        transform: scale(1.05);
    }
    
    /* کد ملک */
    .property-code {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
        border-radius: var(--border-radius-sm);
        z-index: 2;
        backdrop-filter: blur(4px);
    }
    
    /* وضعیت */
    .property-status {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 2;
        padding: 0.3rem 0.7rem;
        border-radius: var(--border-radius-round);
        font-size: 0.7rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .property-status.available {
        background: var(--success-color);
        color: white;
    }
    
    .property-status.sold {
        background: var(--danger-color);
        color: white;
    }
    
    .property-status.rented {
        background: var(--danger-color);
        color: white;
    }
    
    .property-status.reserved {
        background: var(--info-color);
        color: white;
    }
    
    .property-status.building {
        background: var(--text-muted);
        color: white;
    }
    
    .property-status.ready {
        background: var(--warning-color);
        color: white;
    }
    
    /* محتوا */
    .property-content {
        padding: 1.2rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    
    .property-title {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--text-primary);
    }
    
    .property-location {
        font-size: 0.8rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        margin-bottom: 0.7rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .property-location i {
        margin-left: 0.4rem;
        color: var(--primary-color);
    }
    
    /* ویژگی‌ها */
    .property-features {
        display: flex;
        justify-content: space-between;
        padding: 0.7rem 0;
        border-top: 1px solid rgba(0,0,0,0.05);
        margin-bottom: 0.7rem;
    }
    
    .feature-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .feature-value {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    
    .feature-label {
        font-size: 0.7rem;
        color: var(--text-muted);
    }
    
    /* قیمت */
    .property-price {
        margin-top: auto;
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--primary-color);
    }
    
    .property-price span {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 400;
        margin-right: 0.3rem;
    }
    
    .transaction-type {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        background: rgba(74, 108, 247, 0.1);
        color: var(--primary-color);
        border-radius: var(--border-radius-sm);
        font-size: 0.7rem;
        font-weight: 600;
        margin-right: 0.5rem;
    }
    
    /* Actions */
    .property-actions {
        display: flex;
        margin-top: 0.8rem;
    }
    
    .action-button {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        background: rgba(74, 108, 247, 0.05);
        color: var(--primary-color);
        border-radius: var(--border-radius-md);
        font-size: 0.8rem;
        font-weight: 500;
        transition: var(--transition-fast);
        text-decoration: none;
    }
    
    .action-button:hover {
        background: rgba(74, 108, 247, 0.1);
        transform: translateY(-2px);
    }
    
    .action-button i {
        margin-left: 0.4rem;
    }
    
    .action-button + .action-button {
        margin-right: 0.5rem;
    }
    
    /* بدون نتیجه */
    .no-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 0;
        text-align: center;
    }
    
    .no-results-icon {
        font-size: 4rem;
        color: #e2e8f0;
        margin-bottom: 1.5rem;
    }
    
    .no-results-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.8rem;
    }
    
    .no-results-text {
        color: var(--text-muted);
        max-width: 500px;
        margin: 0 auto 1.5rem auto;
    }
    
    .no-results-button {
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: var(--border-radius-md);
        padding: 0.7rem 1.5rem;
        font-weight: 600;
        transition: var(--transition-normal);
    }
    
    .no-results-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(38, 81, 233, 0.2);
    }
    
    /* ویرایش وضعیت */
    .status-dropdown-menu {
        min-width: 200px;
        padding: 0.5rem;
        border: none;
        box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        border-radius: var(--border-radius-md);
    }
    
    .status-option {
        padding: 0.5rem 0.7rem;
        border-radius: var(--border-radius-sm);
        transition: var(--transition-fast);
    }
    
    .status-option:hover {
        background-color: rgba(74, 108, 247, 0.05);
    }
    
    .status-option.active {
        background-color: rgba(74, 108, 247, 0.1);
        font-weight: 600;
    }
    
    /* صفحه‌بندی */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 3rem;
    }
    
    .pagination-button {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: white;
        border: 1px solid var(--border-light);
        margin: 0 0.3rem;
        color: var(--text-primary);
        font-weight: 600;
        transition: var(--transition-normal);
        text-decoration: none;
    }
    
    .pagination-button:hover {
        background: rgba(74, 108, 247, 0.05);
        transform: translateY(-2px);
        border-color: var(--primary-color);
    }
    
    .pagination-button.active {
        background: var(--primary-gradient);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 10px rgba(38, 81, 233, 0.2);
    }
    
    .pagination-prev, .pagination-next {
        width: auto;
        padding: 0 1rem;
        border-radius: var(--border-radius-round);
    }
    
    /* انیمیشن‌ها */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-delay-1 { animation-delay: 0.1s; }
    .animate-delay-2 { animation-delay: 0.2s; }
    .animate-delay-3 { animation-delay: 0.3s; }
    .animate-delay-4 { animation-delay: 0.4s; }
    
    /* موبایل */
    @media (max-width: 991px) {
        .search-header {
            padding: 2rem 0;
        }
        
        .search-title {
            font-size: 1.5rem;
        }
        
        .search-subtitle {
            font-size: 1rem;
        }
        
        .search-bar {
            flex-direction: column;
            padding: 0.5rem;
        }
        
        .search-input {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .search-button {
            width: 100%;
        }
        
        .advanced-filters {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 1050;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        .advanced-filters.show {
            transform: translateX(0);
        }
        
        .filter-close-btn {
            display: block;
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 1051;
        }
        
        .mobile-filter-button {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px rgba(38, 81, 233, 0.3);
            border: none;
            font-size: 1.5rem;
            z-index: 1040;
            animation: pulse 2s infinite;
        }
        
        .property-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        }
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(38, 81, 233, 0.5);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(38, 81, 233, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(38, 81, 233, 0);
        }
    }
    
    /* Welcome message */
    .welcome-message {
        padding: 3rem 0;
        text-align: center;
    }
    
    .welcome-icon {
        font-size: 4rem;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        background: -webkit-linear-gradient(45deg, #4A6CF7, #2651E9);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .welcome-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }
    
    .welcome-text {
        color: var(--text-muted);
        max-width: 700px;
        margin: 0 auto 2rem auto;
        line-height: 1.7;
        font-size: 1.1rem;
    }
    
    .welcome-illustration {
        max-width: 500px;
        margin: 0 auto;
    }
    
    /* Placeholder card animation */
    .placeholder-shimmer {
        position: relative;
        overflow: hidden;
        background: #f6f7f8;
    }
    
    .placeholder-shimmer::after {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        transform: translateX(-100%);
        background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0,
            rgba(255, 255, 255, 0.2) 20%,
            rgba(255, 255, 255, 0.5) 60%,
            rgba(255, 255, 255, 0)
        );
        animation: shimmer 2s infinite;
        content: '';
    }
    
    @keyframes shimmer {
        100% {
            transform: translateX(100%);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- NoUISlider library -->
<script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
<!-- Status manager script -->
<script src="/static/js/status-manager.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables
    const filterForm = document.getElementById('filterForm');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const advancedFilters = document.getElementById('advancedFilters');
    const filterToggle = document.getElementById('filterToggle');
    const mobileFilterButton = document.getElementById('mobileFilterButton');
    const filterCloseBtn = document.getElementById('filterCloseBtn');
    const sortSelect = document.getElementById('sortSelect');
    const resultsContainer = document.getElementById('resultsContainer');
    const clearFiltersButton = document.getElementById('clearFiltersButton');
    const removeFilterButtons = document.querySelectorAll('.remove-filter');
    
    // Show results container if has search parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.toString()) {
        resultsContainer.classList.add('visible');
    }
    
    // Toggle advanced filters
    if (filterToggle) {
        filterToggle.addEventListener('click', function() {
            const isVisible = advancedFilters.classList.contains('show');
            advancedFilters.classList.toggle('show', !isVisible);
            
            // Update button text
            this.innerHTML = isVisible
                ? '<i class="bi bi-sliders"></i> نمایش فیلترهای پیشرفته'
                : '<i class="bi bi-x-lg"></i> بستن فیلترهای پیشرفته';
        });
    }
    
    // Mobile filter toggle
    if (mobileFilterButton) {
        mobileFilterButton.addEventListener('click', function() {
            advancedFilters.classList.add('show');
        });
    }
    
    // Close mobile filters
    if (filterCloseBtn) {
        filterCloseBtn.addEventListener('click', function() {
            advancedFilters.classList.remove('show');
        });
    }
    
    // Handle filter form submission
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            // Close mobile filters if open
            advancedFilters.classList.remove('show');
            
            // Show loading state
            if (searchButton) {
                searchButton.disabled = true;
                searchButton.innerHTML = '<i class="bi bi-hourglass-split"></i> در حال جستجو...';
            }
            
            // Show results container with animation
            resultsContainer.classList.add('visible');
        });
    }
    
    // Handle sort change
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            // Add sort parameter to current URL and navigate
            const url = new URL(window.location);
            url.searchParams.set('sort', this.value);
            window.location = url;
        });
        
        // Set current sort value from URL
        const sortParam = urlParams.get('sort');
        if (sortParam) {
            sortSelect.value = sortParam;
        }
    }
    
    // Remove filter tags
    if (removeFilterButtons.length > 0) {
        removeFilterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filterTag = this.closest('.filter-tag');
                const filterName = filterTag.dataset.filter;
                
                // Create URL object from current location
                const url = new URL(window.location);
                
                // Remove the parameter
                url.searchParams.delete(filterName);
                
                // Special cases for range filters
                if (filterName === 'price_range') {
                    url.searchParams.delete('min_price');
                    url.searchParams.delete('max_price');
                }
                
                if (filterName === 'area_range') {
                    url.searchParams.delete('min_area');
                    url.searchParams.delete('max_area');
                }
                
                // Navigate to the new URL
                window.location = url;
            });
        });
    }
    
    // Clear all filters
    if (clearFiltersButton) {
        clearFiltersButton.addEventListener('click', function() {
            window.location = window.location.pathname;
        });
    }
    
    // Initialize price range slider
    const priceSlider = document.getElementById('priceRangeSlider');
    if (priceSlider) {
        const minPriceInput = document.getElementById('minPriceInput');
        const maxPriceInput = document.getElementById('maxPriceInput');
        const minPriceLabel = document.getElementById('minPriceLabel');
        const maxPriceLabel = document.getElementById('maxPriceLabel');
        
        // Initial values
        const minPrice = minPriceInput.value ? parseInt(minPriceInput.value) : 0;
        const maxPrice = maxPriceInput.value ? parseInt(maxPriceInput.value) : 10000000000;
        
        noUiSlider.create(priceSlider, {
            start: [minPrice, maxPrice],
            connect: true,
            direction: 'rtl',
            step: 100000,
            range: {
                'min': 0,
                'max': 10000000000
            }
        });
        
        // Update inputs and labels on slider change
        priceSlider.noUiSlider.on('update', function(values, handle) {
            const value = parseInt(values[handle]);
            // Format number with commas
            const formattedValue = new Intl.NumberFormat('fa-IR').format(value);
            
            if (handle === 0) {
                minPriceInput.value = value;
                minPriceLabel.textContent = formattedValue + ' تومان';
            } else {
                maxPriceInput.value = value;
                maxPriceLabel.textContent = formattedValue + ' تومان';
            }
        });
    }
    
    // Initialize area range slider
    const areaSlider = document.getElementById('areaRangeSlider');
    if (areaSlider) {
        const minAreaInput = document.getElementById('minAreaInput');
        const maxAreaInput = document.getElementById('maxAreaInput');
        const minAreaLabel = document.getElementById('minAreaLabel');
        const maxAreaLabel = document.getElementById('maxAreaLabel');
        
        // Initial values
        const minArea = minAreaInput.value ? parseInt(minAreaInput.value) : 0;
        const maxArea = maxAreaInput.value ? parseInt(maxAreaInput.value) : 1000;
        
        noUiSlider.create(areaSlider, {
            start: [minArea, maxArea],
            connect: true,
            direction: 'rtl',
            step: 5,
            range: {
                'min': 0,
                'max': 1000
            }
        });
        
        // Update inputs and labels on slider change
        areaSlider.noUiSlider.on('update', function(values, handle) {
            const value = parseInt(values[handle]);
            // Format number with commas
            const formattedValue = new Intl.NumberFormat('fa-IR').format(value);
            
            if (handle === 0) {
                minAreaInput.value = value;
                minAreaLabel.textContent = formattedValue + ' متر مربع';
            } else {
                maxAreaInput.value = value;
                maxAreaLabel.textContent = formattedValue + ' متر مربع';
            }
        });
    }
    
    // Lazy load images for better performance
    const lazyImages = document.querySelectorAll('img.lazy');
    if (lazyImages.length > 0) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                    observer.unobserve(img);
                }
            });
        });
        
        lazyImages.forEach(img => imageObserver.observe(img));
    }
});
</script>
{% endblock %}

{% block title %}جستجوی پیشرفته املاک | سیستم مدیریت املاک هیرو{% endblock %}

{% block content %}
<!-- Header Section -->
<header class="search-header">
    <div class="container">
        <h1 class="search-title">جستجوی حرفه‌ای املاک</h1>
        <p class="search-subtitle">با استفاده از سیستم جستجوی پیشرفته، ملک مورد نظر خود را پیدا کنید</p>
        
        <form action="{% url 'properties:property_search' %}" method="get" id="searchForm">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" name="query" 
                       placeholder="جستجو بر اساس عنوان، موقعیت، کد ملک و..." 
                       value="{{ request.GET.query }}">
                <button type="submit" class="search-button" id="searchButton">
                    <i class="bi bi-search"></i>
                    جستجو
                </button>
            </div>
        </form>
        
        <button type="button" class="filter-toggle" id="filterToggle">
            <i class="bi bi-sliders"></i>
            نمایش فیلترهای پیشرفته
        </button>
    </div>
</header>

<!-- Main Content -->
<div class="content-container">
    <div class="container">
        <div class="row">
            <!-- Right Column - Filters -->
            <div class="col-lg-4">
                <!-- Advanced Filters -->
                <div class="advanced-filters" id="advancedFilters">
                    <div class="filter-header">
                        <h5>
                            <i class="bi bi-funnel-fill"></i>
                            فیلترهای پیشرفته
                        </h5>
                        <span class="collapse-toggle d-none d-lg-flex" id="collapseFilters">
                            <i class="bi bi-chevron-up"></i>
                        </span>
                        <button type="button" class="filter-close-btn d-lg-none" id="filterCloseBtn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    
                    <div class="filter-body">
                        <form id="filterForm" action="{% url 'properties:property_search' %}" method="get">
                            <!-- Current search query (hidden) -->
                            {% if request.GET.query %}
                            <input type="hidden" name="query" value="{{ request.GET.query }}">
                            {% endif %}
                            
                            <!-- Property Type Section -->
                            <div class="filter-section">
                                <div class="filter-section-title">
                                    <i class="bi bi-house"></i>
                                    نوع ملک و معامله
                                </div>
                                
                                <div class="mb-3">
                                    <label for="transaction_type" class="form-label">نوع معامله</label>
                                    <select class="form-select" id="transaction_type" name="transaction_type">
                                        <option value="">همه موارد</option>
                                        {% for type in transaction_types %}
                                        <option value="{{ type.id }}" {% if request.GET.transaction_type == type.id|stringformat:"i" %}selected{% endif %}>{{ type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="property_type" class="form-label">نوع ملک</label>
                                    <select class="form-select" id="property_type" name="property_type">
                                        <option value="">همه موارد</option>
                                        {% for type in property_types %}
                                        <option value="{{ type.id }}" {% if request.GET.property_type == type.id|stringformat:"i" %}selected{% endif %}>{{ type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="property_status" class="form-label">وضعیت ملک</label>
                                    <select class="form-select" id="property_status" name="status">
                                        <option value="">همه موارد</option>
                                        {% for status in property_statuses %}
                                        <option value="{{ status.id }}" {% if request.GET.status == status.id|stringformat:"i" %}selected{% endif %}>{{ status.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Price Range Section -->
                            <div class="filter-section">
                                <div class="filter-section-title">
                                    <i class="bi bi-cash-stack"></i>
                                    محدوده قیمت
                                </div>
                                
                                <div class="range-slider">
                                    <div id="priceRangeSlider"></div>
                                    <div class="range-labels">
                                        <span id="minPriceLabel">0 تومان</span>
                                        <span id="maxPriceLabel">10,000,000,000 تومان</span>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="minPriceInput" name="min_price" value="{{ request.GET.min_price }}">
                                <input type="hidden" id="maxPriceInput" name="max_price" value="{{ request.GET.max_price }}">
                            </div>
                            
                            <!-- Area Range Section -->
                            <div class="filter-section">
                                <div class="filter-section-title">
                                    <i class="bi bi-rulers"></i>
                                    متراژ (متر مربع)
                                </div>
                                
                                <div class="range-slider">
                                    <div id="areaRangeSlider"></div>
                                    <div class="range-labels">
                                        <span id="minAreaLabel">0 متر مربع</span>
                                        <span id="maxAreaLabel">1,000 متر مربع</span>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="minAreaInput" name="min_area" value="{{ request.GET.min_area }}">
                                <input type="hidden" id="maxAreaInput" name="max_area" value="{{ request.GET.max_area }}">
                            </div>
                            
                            <!-- Features Section -->
                            <div class="filter-section">
                                <div class="filter-section-title">
                                    <i class="bi bi-list-check"></i>
                                    ویژگی‌ها و امکانات
                                </div>
                                
                                <div class="mb-3">
                                    <label for="rooms" class="form-label">تعداد اتاق‌ها</label>
                                    <select class="form-select" id="rooms" name="rooms">
                                        <option value="">همه موارد</option>
                                        <option value="1" {% if request.GET.rooms == '1' %}selected{% endif %}>حداقل 1 اتاق</option>
                                        <option value="2" {% if request.GET.rooms == '2' %}selected{% endif %}>حداقل 2 اتاق</option>
                                        <option value="3" {% if request.GET.rooms == '3' %}selected{% endif %}>حداقل 3 اتاق</option>
                                        <option value="4" {% if request.GET.rooms == '4' %}selected{% endif %}>حداقل 4 اتاق</option>
                                        <option value="5" {% if request.GET.rooms == '5' %}selected{% endif %}>5 اتاق یا بیشتر</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="hasParking" name="has_parking" value="1" {% if request.GET.has_parking == '1' %}checked{% endif %}>
                                        <label class="form-check-label" for="hasParking">دارای پارکینگ</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="hasElevator" name="has_elevator" value="1" {% if request.GET.has_elevator == '1' %}checked{% endif %}>
                                        <label class="form-check-label" for="hasElevator">دارای آسانسور</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="hasStorage" name="has_storage" value="1" {% if request.GET.has_storage == '1' %}checked{% endif %}>
                                        <label class="form-check-label" for="hasStorage">دارای انباری</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Submit Section -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>
                                    جستجوی املاک
                                </button>
                                <a href="{% url 'properties:property_search' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>
                                    پاک کردن فیلترها
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Left Column - Results -->
            <div class="col-lg-8">
                <!-- Results Container -->
                <div class="results-container" id="resultsContainer">
                    {% if has_filters or request.GET.query %}
                        <!-- Active Filters -->
                        {% if has_filters %}
                        <div class="active-filters mb-3">
                            {% if request.GET.query %}
                            <div class="filter-tag" data-filter="query">
                                <i class="bi bi-x-circle remove-filter"></i>
                                عبارت: {{ request.GET.query }}
                            </div>
                            {% endif %}
                            
                            {% if request.GET.transaction_type %}
                            <div class="filter-tag" data-filter="transaction_type">
                                <i class="bi bi-x-circle remove-filter"></i>
                                نوع معامله: {{ transaction_type_name }}
                            </div>
                            {% endif %}
                            
                            {% if request.GET.property_type %}
                            <div class="filter-tag" data-filter="property_type">
                                <i class="bi bi-x-circle remove-filter"></i>
                                نوع ملک: {{ property_type_name }}
                            </div>
                            {% endif %}
                            
                            {% if request.GET.status %}
                            <div class="filter-tag" data-filter="status">
                                <i class="bi bi-x-circle remove-filter"></i>
                                وضعیت: {{ status_name }}
                            </div>
                            {% endif %}
                            
                            {% if request.GET.min_price or request.GET.max_price %}
                            <div class="filter-tag" data-filter="price_range">
                                <i class="bi bi-x-circle remove-filter"></i>
                                قیمت: {{ price_range }}
                            </div>
                            {% endif %}
                            
                            {% if request.GET.min_area or request.GET.max_area %}
                            <div class="filter-tag" data-filter="area_range">
                                <i class="bi bi-x-circle remove-filter"></i>
                                متراژ: {{ area_range }}
                            </div>
                            {% endif %}
                            
                            {% if request.GET.rooms %}
                            <div class="filter-tag" data-filter="rooms">
                                <i class="bi bi-x-circle remove-filter"></i>
                                حداقل {{ request.GET.rooms }} اتاق
                            </div>
                            {% endif %}
                            
                            {% if request.GET.has_parking %}
                            <div class="filter-tag" data-filter="has_parking">
                                <i class="bi bi-x-circle remove-filter"></i>
                                دارای پارکینگ
                            </div>
                            {% endif %}
                            
                            {% if request.GET.has_elevator %}
                            <div class="filter-tag" data-filter="has_elevator">
                                <i class="bi bi-x-circle remove-filter"></i>
                                دارای آسانسور
                            </div>
                            {% endif %}
                            
                            {% if request.GET.has_storage %}
                            <div class="filter-tag" data-filter="has_storage">
                                <i class="bi bi-x-circle remove-filter"></i>
                                دارای انباری
                            </div>
                            {% endif %}
                            
                            <div class="filter-tag clear-filters" id="clearFiltersButton">
                                <i class="bi bi-trash"></i>
                                پاک کردن همه فیلترها
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Search Stats -->
                        <div class="search-stats">
                            <div class="search-stats-count">
                                <span>{{ properties.count }}</span> ملک پیدا شد
                            </div>
                            <div class="search-sort">
                                <span class="sort-label">مرتب‌سازی:</span>
                                <select class="sort-select" id="sortSelect">
                                    <option value="newest" {% if request.GET.sort == 'newest' or not request.GET.sort %}selected{% endif %}>جدیدترین</option>
                                    <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>قیمت (کم به زیاد)</option>
                                    <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>قیمت (زیاد به کم)</option>
                                    <option value="area_asc" {% if request.GET.sort == 'area_asc' %}selected{% endif %}>متراژ (کوچک به بزرگ)</option>
                                    <option value="area_desc" {% if request.GET.sort == 'area_desc' %}selected{% endif %}>متراژ (بزرگ به کوچک)</option>
                                </select>
                            </div>
                        </div>
                        
                        {% if properties %}
                        <!-- Property Grid -->
                        <div class="property-grid">
                            {% for property in properties %}
                            <div class="property-card" style="animation-delay: {{ forloop.counter0|divisibleby:3 }}00ms">
                                <div class="property-image-container">
                                    {% if property.image %}
                                    <img src="{{ property.image.url }}" class="property-image" alt="{{ property.title }}">
                                    {% elif system_config.default_property_image %}
                                    <img src="{{ system_config.default_property_image.url }}" class="property-image" alt="{{ property.title }}">
                                    {% else %}
                                    <div class="placeholder-shimmer" style="width: 100%; height: 100%;"></div>
                                    {% endif %}
                                    
                                    <div class="property-code">{{ property.property_code }}</div>
                                    
                                    <div class="property-status {% if property.status.name == 'موجود' %}available{% elif property.status.name == 'فروخته شده' %}sold{% elif property.status.name == 'اجاره داده شده' %}rented{% elif property.status.name == 'رزرو شده' %}reserved{% elif property.status.name == 'در حال ساخت' %}building{% else %}ready{% endif %}">
                                        {{ property.status.name }}
                                    </div>
                                </div>
                                
                                <div class="property-content">
                                    <h3 class="property-title">{{ property.title }}</h3>
                                    
                                    <div class="property-location">
                                        <i class="bi bi-geo-alt-fill"></i>
                                        {{ property.address|truncatechars:50 }}
                                    </div>
                                    
                                    <div class="property-features">
                                        <div class="feature-item">
                                            <div class="feature-value">{{ property.area }}</div>
                                            <div class="feature-label">متر مربع</div>
                                        </div>
                                        
                                        <div class="feature-item">
                                            <div class="feature-value">{{ property.rooms }}</div>
                                            <div class="feature-label">اتاق</div>
                                        </div>
                                        
                                        <div class="feature-item">
                                            <div class="feature-value">{{ property.year_built }}</div>
                                            <div class="feature-label">سال ساخت</div>
                                        </div>
                                    </div>
                                    
                                    <div class="property-price">
                                        <span class="transaction-type">{{ property.transaction_type.name }}</span>
                                        {{ property.price|floatformat:"0"|intcomma }} تومان
                                    </div>
                                    
                                    <div class="property-actions">
                                        <a href="{% url 'properties:property_detail' property.id %}" class="action-button">
                                            <i class="bi bi-eye-fill"></i>
                                            مشاهده جزئیات
                                        </a>
                                        
                                        {% if user.is_staff %}
                                        <button type="button" class="action-button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-arrow-repeat"></i>
                                            تغییر وضعیت
                                        </button>
                                        <ul class="dropdown-menu status-dropdown-menu" aria-labelledby="statusButton{{ property.id }}">
                                            <li><h6 class="dropdown-header">تغییر به وضعیت جدید:</h6></li>
                                            {% for status in status_choices %}
                                            <li>
                                                <a class="dropdown-item status-option {% if property.status.id == status.id %}active{% endif %}" 
                                                   href="#" 
                                                   data-property-id="{{ property.id }}" 
                                                   data-status-id="{{ status.id }}" 
                                                   data-status-name="{{ status.name }}">
                                                    <span class="badge {% if status.name == 'موجود' %}bg-success{% elif status.name == 'فروخته شده' or status.name == 'اجاره داده شده' %}bg-danger{% elif status.name == 'رزرو شده' %}bg-warning{% elif status.name == 'در حال ساخت' %}bg-info{% elif status.name == 'آماده تحویل' %}bg-primary{% else %}bg-secondary{% endif %} me-1">
                                                        {{ status.name }}
                                                    </span>
                                                </a>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Pagination -->
                        {% if is_paginated %}
                        <div class="pagination-container">
                            {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-button pagination-prev">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                            {% endif %}
                            
                            {% for i in paginator.page_range %}
                                {% if page_obj.number == i %}
                                <span class="pagination-button active">{{ i }}</span>
                                {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                                <a href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-button">{{ i }}</a>
                                {% endif %}
                            {% endfor %}
                            
                            {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="pagination-button pagination-next">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% else %}
                        <!-- No Results -->
                        <div class="no-results">
                            <div class="no-results-icon">
                                <i class="bi bi-search"></i>
                            </div>
                            <h3 class="no-results-title">نتیجه‌ای پیدا نشد!</h3>
                            <p class="no-results-text">متأسفانه ملکی با مشخصات مورد نظر شما یافت نشد. لطفاً معیارهای جستجوی خود را تغییر دهید.</p>
                            <a href="{% url 'properties:property_search' %}" class="btn btn-primary">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>
                                پاک کردن همه فیلترها
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                        <!-- Welcome Message (For First Visit) -->
                        <div class="welcome-message">
                            <div class="welcome-icon">
                                <i class="bi bi-house-heart"></i>
                            </div>
                            <h2 class="welcome-title">به سیستم جستجوی پیشرفته املاک خوش آمدید</h2>
                            <p class="welcome-text">
                                برای شروع، از نوار جستجو بالا استفاده کنید یا فیلترهای پیشرفته را برای یافتن ملک ایده‌آل خود تنظیم کنید.
                                همچنین می‌توانید از امکان جستجوی سریع برای مشاهده همه املاک استفاده کنید.
                            </p>
                            <div class="welcome-action">
                                <button type="button" class="btn btn-lg btn-primary" onclick="document.getElementById('searchForm').submit();">
                                    <i class="bi bi-search me-2"></i>
                                    نمایش همه املاک
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Filter Button -->
<button type="button" class="mobile-filter-button d-lg-none" id="mobileFilterButton">
    <i class="bi bi-funnel-fill"></i>
</button>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">تغییر وضعیت ملک</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>آیا از تغییر وضعیت این ملک مطمئن هستید؟</p>
                <div class="status-change-details">
                    <p>وضعیت فعلی: <span id="currentStatus" class="fw-bold"></span></p>
                    <p>وضعیت جدید: <span id="newStatus" class="fw-bold"></span></p>
                </div>
                <div class="form-group">
                    <label for="statusChangeNote">یادداشت (اختیاری)</label>
                    <textarea class="form-control" id="statusChangeNote" rows="3" placeholder="دلیل تغییر وضعیت را وارد کنید..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmStatusChange">
                    <i class="bi bi-check-lg me-1"></i>
                    تأیید تغییر وضعیت
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>
                    انصراف
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}